<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mantra - Client</title>
  <link rel="stylesheet" href="/mantra.css">
  <script type="module" src="/mantra.js"></script>
  <script type="module" src="/realstone.js"></script>
  <script type="module" src="/realDemo.js"></script>
  <style>
    #contraption-interface {
      text-align: center;
      margin-top: 20px;
    }

    #save-contraption-form {
      margin-bottom: 20px;
    }

    #display-contraption {
      margin-top: 20px;
      display: none;
    }

    textarea {
      position: absolute;
      top: 0;
      left: 0;
      width: 400px;
      height: 800px;
    }
  </style>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('save-contraption-form');
      const contraptionNameDisplay = document.getElementById('contraption-name-display');

      form.addEventListener('submit', function (event) {
        event.preventDefault();
        const contraptionName = document.getElementById('contraption-name').value;
        // Implement the POST request to save the contraption
        saveContraption(contraptionName);
      });

      const runContraptionForm = document.getElementById('run-contraption-form');
      runContraptionForm.addEventListener('submit', function (event) {
        event.preventDefault();
        const contraptionCode = document.getElementById('contraption-code').value;
        // Implement the POST request to save the contraption
        runContraption(contraptionCode);
      });

      async function saveContraption(name) {


        // get the code from the textarea
        let contraptionCode = document.getElementById('contraption-code').value;
        // Assuming roverLightSystem is a variable that holds the contraption code
        const payload = {
          name: name,
          code: contraptionCode || '' // This should be defined in your scope
        };

        try {
          const response = await fetch(`${etherspaceEndpoint}/api/v1/contraption/${name}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
          });

          const data = await response.json();

          if (response.ok) {
            contraptionNameDisplay.textContent = `Saved: ${data.name}`;
          } else {
            contraptionNameDisplay.textContent = `Error saving contraption: ${data.message}`;
          }
        } catch (error) {
          contraptionNameDisplay.textContent = `Network error: ${error.message}`;
        }

        let displayContraption = document.getElementById('display-contraption');
        if (displayContraption) {
          displayContraption.style.display = 'block';
        }
      }

      let etherspaceHost = 'http://192.168.1.80:8889';
      let etherspaceEndpoint = etherspaceHost + '';


      async function getContraption(contraptionId) {
        // Implement GET request to fetch contraption
        const response = await fetch(`${etherspaceEndpoint}/api/v1/contraption/${contraptionId}`);
        const data = await response.json();

        if (data) {
          contraptionNameDisplay.textContent = data.name; // Update display with fetched name
        } else {
          contraptionNameDisplay.textContent = 'Could not find: ' + contraptionId;
        }
        let displayContraption = document.getElementById('display-contraption');
        if (displayContraption) {
          displayContraption.style.display = 'block';
        }

        // set contraption-code textarea value to fetched code
        let contraptionCode = document.getElementById('contraption-code');
        if (contraptionCode) {
          contraptionCode.value = data.code;
        }

        //contraptionNameDisplay.style.display = 'block';
      }

      // Example usage
      getContraption('rover-light');
    });

    function runContraption (code) {
      // alert(code)
      // TODO: eval code
      // let yes = confirm(`You are about to eval() this code: ${code}`)
      let yes = true;
      if (yes) {
        eval(code)

        console.log('rrrr', roverLightSystem)
        game.use('RealStone', {
          contraption: roverLightSystem
        });


      }
    }

  </script>
</head>

<body>
  <div id="contraption-interface">
    <div id="display-contraption">
      <h3>Contraption Name: <span id="contraption-name-display"></span></h3>
    </div>
    <form id="save-contraption-form">
      <input type="text" id="contraption-name" placeholder="Enter contraption name" value="rover-light" required>
      <button type="submit">Save Contraption</button>
    </form>
    <form id="run-contraption-form">
      <button type="submit">Run Contraption</button>
      <!-- TODO Monaco editor -->
      <textarea id="contraption-code" rows="10" cols="50" placeholder="Enter contraption code here"></textarea>
  </div>
  <script>
    // JavaScript to handle form submission and fetching contraption
  </script>
</body>

</html>